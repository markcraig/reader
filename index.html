<!DOCTYPE html>
<!--
! MPL 2.0 HEADER START
!
! This Source Code Form is subject to the terms of the Mozilla Public
! License, v. 2.0. If a copy of the MPL was not distributed with this
! file, You can obtain one at http://mozilla.org/MPL/2.0/.
!
! If applicable, add the following below this MPL 2.0 HEADER, replacing
! the fields enclosed by brackets "[]" replaced with your own identifying
! information:
!     Portions Copyright [yyyy] [name of copyright owner]
!
! MPL 2.0 HEADER END
!
!     Copyright 2013 Mark Craig
!
-->
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Some Feeds</title>
        <style type="text/css">
        /* Run the text down the center of a 640px page. */
        body {
            font-family: Verdana, Helvetica, Arial, sans-serif;
            margin-left: auto;
            margin-right: auto;
            max-width: 640px;
        }
        
        a {
         text-decoration: none;
        }
        
        a:active, a:hover {
         color: #f58220;
        }
        </style>
    </head>
    
    <body>
        <h1>Some Feeds</h1>
        
        <p>This page uses the <a href="https://developers.google.com/feed/v1/"
        >Google Feed API</a>. It sets a cookie to avoid displaying items
        that you have already seen.</p>
        
        <div id="feed"></div>


        <!--
            For loading the feed API
        -->
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>


        <!-- 
            For getting and setting cookies, etc.
        -->
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script type="text/javascript" src="js/jquery.cookie.js"></script>


        <!--
            Cleaner source for creating a list of feeds
            Handlebars template causes Cloud9 IDE to complain, however.
        -->
        
        <script type="text/javascript" src="js/handlebars.js"></script>        
        <script id="feed-template" type="text/x-handlebars-template">
        
            <div class="feed">
              <a href="{{link}}" target="_blank"><h2>{{feed}}</h2></a>
              {{#each entries}}
              <div class="entry">
                <div class="title"><a href="{{link}}" target="_blank">{{title}}</a></div>
                <div class="content">{{{content}}}</div>
              </div>
              {{/each}}
            </div>

        </script>

        <script type="text/javascript">
var source   = $("#feed-template").html();
var template = Handlebars.compile(source);

// Choice of feeds (static for now).
var myFeeds = [
    "http://andrewgavinmarshall.com/feed/",
    "http://great-hikes.com/blog/feed/",
    "http://blog.arnaudlacour.com/feeds/posts/default",
    "http://www.schneier.com/blog/atom.xml",
    "http://feeds2.feedburner.com/clusterfucknation",
    "http://www.jwz.org/blog/feed/",
    "http://ludopoitou.wordpress.com/feed/",
    "http://marginnotes2.wordpress.com/feed/",
    "http://www.tri4joe.com/feed/",
    "http://www.dirmgr.com/blog/rss.xml",
    "http://chomskydotinfo.blogspot.com/rss.xml",
    "http://earthly-powers.blogspot.com/rss.xml",
    "http://webmink.com/feed/",
    "https://www.tbray.org/ongoing/ongoing.atom",
    "https://wikis.forgerock.org/confluence/createrssfeed.action?types=page&types=blogpost&types=mail&types=comment&types=attachment&sort=modified&showContent=true&showDiff=true&spaces=conf_all&labelString%3D&rssType=atom&maxResults=10&timeSpan=5&publicFeed=true&title=ForgeRock+Wiki+RSS+Feed"
];

var cookieName = 'RLV';     // Reader Last Visit
var lastVisit;              // Timestamp of last visit

google.load("feeds", "1");

/**
 * Template feeds and display them in the page.
 */
function process(result) {
    if (!result.error) {
        var theEntries = [];
        for (var j = 0; j < result.feed.entries.length;j++) {
            var entry = result.feed.entries[j];
            if (lastVisit !== undefined
                && lastVisit > new Date(entry.publishedDate)) {
                continue;    
            }

            theEntries.push({
                link: entry.link,
                title: entry.title,
                content: entry.content
            });
        }

        if (theEntries.length) {
            $("#feed").append(template({
                link: result.feed.link,
                feed: result.feed.title,
                entries: theEntries
            }));
        }
    }
}

/**
 * Get and process feeds.
 * 
 * If the user-agent reloads within a week, display only recent entries.
 */
function initialize() {
    var cookie = $.cookie(cookieName);
    if (cookie !== undefined) {
        lastVisit = new Date(cookie);
    }
    
    for(var i = 0; i < myFeeds.length; i++) {
        var feed = new google.feeds.Feed(myFeeds[i]);
        feed.load(process);
    }
    
    // Let the last visit expire after a week.
    //$.cookie(cookieName, (new Date()).toString(), { expires: 7 });
}

google.setOnLoadCallback(initialize);
    </script>
    </body>
</html>